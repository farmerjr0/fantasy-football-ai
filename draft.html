<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Draft Room</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
  <h1>Fantasy Draft Room</h1>

  <div id="draft-status">
    <p>Round: <span id="round-number">1</span></p>
    <p>Team on the clock: <span id="team-number">1</span></p>
    <p>Timer: <span id="timer">30</span> seconds</p>
    <button id="draft-button" style="display:none;">Draft Selected Player</button>
  </div>

  <div id="search-box">
    <input type="text" id="search" placeholder="Search players by name or position"/>
  </div>

  <div id="available-players">
    <h2>Available Players</h2>
    <ul id="player-list"></ul>
  </div>

  <div id="teams">
    <h2>Teams</h2>
    <div id="team-boards"></div>
  </div>

  <script>
    // === CONFIG ===
    const totalTeams = 10;
    const totalRounds = 15;
    const pickTime = 30; // seconds
    const humanTeam = 1; // user controls this team

    // === STATE ===
    let players = [];
    let currentRound = 1;
    let currentTeam = 1;
    let direction = 1; // 1 = forward, -1 = backward
    let timerInterval = null;
    let selectedPlayerUid = null;

    // === INIT ===
    async function initDraft() {
      try {
        const res = await fetch("../data/rankings.json");
        players = await res.json();
        renderPlayers(players);
        renderTeams();
        updateRoundAndClock();
        startTimer();
      } catch (err) {
        console.error("Error loading player pool:", err);
        document.getElementById("player-list").innerHTML = "<li>Could not load players. Check ../data/rankings.json</li>";
      }
    }

    // === RENDER PLAYERS ===
    function renderPlayers(list = players) {
      const ul = document.getElementById("player-list");
      ul.innerHTML = "";
      list.sort((a,b) => (a.rank ?? 9999) - (b.rank ?? 9999));
      list.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.rank}. ${p.name} (${p.position} - ${p.team ?? ""})`;
        li.onclick = () => {
          selectedPlayerUid = p.uid;
          highlightSelected(li);
        };
        ul.appendChild(li);
      });
    }

    function highlightSelected(li) {
      [...document.querySelectorAll("#player-list li")].forEach(el => el.style.background = "");
      li.style.background = "lightgreen";
    }

    // === RENDER TEAMS ===
    function renderTeams() {
      const container = document.getElementById("team-boards");
      container.innerHTML = "";
      for (let i=1; i<=totalTeams; i++) {
        const div = document.createElement("div");
        div.id = `team-${i}`;
        div.innerHTML = `<h3>Team ${i}</h3><ul></ul>`;
        container.appendChild(div);
      }
    }

    // === TIMER ===
    function startTimer() {
      clearInterval(timerInterval);
      let time = pickTime;
      document.getElementById("timer").textContent = time;

      // Show/hide draft button
      document.getElementById("draft-button").style.display = 
        (currentTeam === humanTeam) ? "inline-block" : "none";

      timerInterval = setInterval(() => {
        time--;
        document.getElementById("timer").textContent = time;
        if (time <= 0) {
          clearInterval(timerInterval);
          if (currentTeam === humanTeam) {
            autoPick(); // timeout = auto AI pick
          } else {
            autoPick();
          }
        }
      }, 1000);

      // If AIâ€™s turn, auto-pick after short delay
      if (currentTeam !== humanTeam) {
        setTimeout(() => {
          autoPick();
        }, 2000);
      }
    }

    // === DRAFT LOGIC ===
    function draftByUid(uid) {
      if (currentRound > totalRounds) return;
      if (currentTeam !== humanTeam) {
        alert("It's not your turn!");
        return;
      }
      draftAction(uid);
    }

    function draftAction(uid) {
      const idx = players.findIndex(p => p.uid === uid);
      if (idx === -1) return;

      const player = players.splice(idx, 1)[0];

      const teamUL = document.querySelector(`#team-${currentTeam} ul`);
      const li = document.createElement("li");
      li.textContent = `${player.name} (${player.position}${player.team ? " - " + player.team : ""})`;
      teamUL.appendChild(li);

      moveSnake();
      updateRoundAndClock();
      renderPlayers();
    }

    function autoPick() {
      if (players.length === 0 || currentRound > totalRounds) return;
      const best = players.sort((a,b) => (a.rank ?? 9999) - (b.rank ?? 9999))[0];
      if (best) draftAction(best.uid);
    }

    function moveSnake() {
      if (direction === 1 && currentTeam === totalTeams) {
        direction = -1;
        currentRound++;
      } else if (direction === -1 && currentTeam === 1) {
        direction = 1;
        currentRound++;
      } else {
        currentTeam += direction;
      }
    }

    function updateRoundAndClock() {
      document.getElementById("round-number").textContent = currentRound;
      document.getElementById("team-number").textContent = currentTeam;
      if (currentRound <= totalRounds) startTimer();
    }

    // === SEARCH ===
    document.getElementById("search").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = players.filter(p =>
        p.name.toLowerCase().includes(term) ||
        p.position.toLowerCase().includes(term) ||
        (p.team && p.team.toLowerCase().includes(term))
      );
      renderPlayers(filtered);
    });

    // === BUTTON ===
    document.getElementById("draft-button").addEventListener("click", () => {
      if (selectedPlayerUid) {
        draftByUid(selectedPlayerUid);
        selectedPlayerUid = null;
      } else {
        alert("Please select a player first!");
      }
    });

    // === START ===
    initDraft();
  </script>
</body>
</html>
